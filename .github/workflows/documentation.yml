name: Update Documentation

on:
  pull_request:
    types:
      - closed

jobs:
  update-wiki:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Set up Doxygen
        run: sudo apt-get install -y doxygen

      - name: Generate Documentation
        id: generate-docs
        run: |
          categories=("airway" "breathing" "chemical" "circulation" "gui" "main" "misc" "pharma" "surgery" "zeus")  # Update with your desired categories

          for file in $(git diff-tree --no-commit-id --name-only -r ${{ github.event.pull_request.merge_commit_sha }}); do
            if [[ $file == *.cpp ]] || [[ $file == *.h ]] || [[ $file == *.sqf ]]; then
              if grep -q "doxygen" "$file"; then
                for category in "${categories[@]}"; do
                  if [[ $file == "$category"/* ]]; then
                    if [[ $file == "fnc_"* ]]; then
                      display_name=$(basename "$file" | cut -c 5-)
                    else
                      display_name=$(basename "$file")
                    fi
                    display_name=$(echo "$display_name" | rev | cut -c 5- | rev)
                    doxygen -d "$category" -D "PROJECT_NAME=$display_name" "$file"
                  fi
                done
              else
                echo "Skipping $file as it does not contain Doxygen comments."
              fi
            fi
          done

      - name: Commit and push changes to Wiki
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/html
